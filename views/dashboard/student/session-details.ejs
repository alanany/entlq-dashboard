<% 
    // ==========================================================
    // ğŸ’¡ 1. Ø¬Ø²Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¶ÙŠØ±Ù‡Ø§ Ù„Ù„ØªØ§ÙŠÙ…Ø± ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ (EJS/Node.js)
    // ==========================================================
    let finalISODateTime = ''; 
    let displayDateTime = '';
    let isSessionValid = false;
    
    // ğŸ’¡ Ø§ÙØªØ±Ø§Ø¶ Ù…Ø¯Ø© Ø§Ù„Ø­ØµØ© Ø¨Ù€ 60 Ø¯Ù‚ÙŠÙ‚Ø© ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªÙƒÙ† Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const sessionDurationMinutes = sessionDetails.duration || 60; 

    if (sessionDetails && sessionDetails.date && sessionDetails.time) {
        
        isSessionValid = true;
        const rawDate = sessionDetails.date; 
        const sessionTime = sessionDetails.time; 
        
        // 1. Ø§Ø³ØªØ®Ù„Ø§Øµ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØª UTC
        const dateObj = new Date(rawDate);
        const year = dateObj.getUTCFullYear();
        const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getUTCDate()).padStart(2, '0');
        
        // 2. Ø¯Ù…Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙÙŠ Ø³Ù„Ø³Ù„Ø© ISO Ù„ØªÙ…Ø«Ù„ ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ù…Ø­Ù„ÙŠ
        finalISODateTime = `${year}-${month}-${day}T${sessionTime}:00`; 
        const displayDateObj = new Date(finalISODateTime);

        // 3. Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
        const formattedDate = displayDateObj.toLocaleDateString('ar-SA', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric'
        });
        const formattedTime = displayDateObj.toLocaleTimeString('ar-SA', { 
            hour: '2-digit', 
            minute: '2-digit', 
            hour12: true 
        });
        
        displayDateTime = `${formattedDate} | ${formattedTime}`;
    }
%>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØºØ±ÙØ© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .countdown-segment {
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="flex h-screen overflow-hidden">
        
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8">
                <h2 class="text-xl font-semibold text-gray-800">ØºØ±ÙØ© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h2>
                <a href="" onclick="history.back(); return false;" class="text-sm text-indigo-600 hover:underline flex items-center font-medium">
                    </i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªÙØ§ØµÙŠÙ„ 
                </a>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-indigo-50 p-8 flex items-center justify-center">
                <div class="max-w-3xl w-full space-y-8 text-center">

                    <div class="bg-indigo-600 text-white p-8 rounded-2xl shadow-xl">
                        <i data-feather="monitor" class="w-12 h-12 mx-auto mb-4 text-indigo-200"></i>
                        <h1 class="text-3xl font-extrabold mb-1" id="sessionTopic"> <%= sessionDetails.topic || sessionDetails.courseTitle %> </h1>
                        <p class="text-indigo-200 text-lg">Ø­ØµØªÙƒ ÙÙŠ ÙƒÙˆØ±Ø³ **<span id="sessionCourse"> <%= sessionDetails.courseTitle %></span>** Ø³ØªØ¨Ø¯Ø£ Ù‚Ø±ÙŠØ¨Ø§Ù‹.</p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                        
                        <h3 id="timerHeader" class="text-xl font-bold text-gray-700 mb-6 flex items-center justify-center">
                            <i data-feather="clock" class="ml-2 w-6 h-6 text-indigo-600"></i>
                            Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø­ØµØ©:
                        </h3>
                        
                        <div id="countdownTimer" class="flex justify-center gap-4 flex-wrap">
                            <div class="countdown-segment bg-indigo-50 p-4 rounded-xl min-w-[90px] shadow-sm">
                                <span id="days" class="text-5xl font-extrabold text-indigo-700 block">00</span>
                                <span class="text-sm text-gray-600">ÙŠÙˆÙ…</span>
                            </div>
                            <div class="countdown-segment bg-indigo-50 p-4 rounded-xl min-w-[90px] shadow-sm">
                                <span id="hours" class="text-5xl font-extrabold text-indigo-700 block">00</span>
                                <span class="text-sm text-gray-600">Ø³Ø§Ø¹Ø©</span>
                            </div>
                            <div class="countdown-segment bg-indigo-50 p-4 rounded-xl min-w-[90px] shadow-sm">
                                <span id="minutes" class="text-5xl font-extrabold text-indigo-700 block">00</span>
                                <span class="text-sm text-gray-600">Ø¯Ù‚ÙŠÙ‚Ø©</span>
                            </div>
                            <div class="countdown-segment bg-indigo-50 p-4 rounded-xl min-w-[90px] shadow-sm">
                                <span id="seconds" class="text-5xl font-extrabold text-indigo-700 block">00</span>
                                <span class="text-sm text-gray-600">Ø«Ø§Ù†ÙŠØ©</span>
                            </div>
                        </div>
                        
                        <p id="timerMessage" class="text-sm font-medium text-red-600 mt-4 hidden">Ø§Ù„Ø²Ø± Ø³ÙŠÙ†Ø´Ø· Ù‚Ø¨Ù„ 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø­ØµØ©.</p>
                    </div>
                    
                    <a href="<%= sessionDetails.link %>" id="joinSessionButton" 
                       class="w-full inline-flex items-center justify-center px-8 py-4 bg-gray-400 text-white text-xl font-bold rounded-xl shadow-lg transition duration-300 pointer-events-none disabled:opacity-50">
                        <i data-feather="log-in" class="ml-3 w-6 h-6"></i>
                        Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¢Ù† (ØºÙŠØ± Ù…ØªØ§Ø­)
                    </a>
                    
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                            <p class="text-sm font-medium text-gray-500 flex items-center justify-center"><i data-feather="calendar" class="ml-2 w-4 h-4"></i> Ø§Ù„Ù…ÙˆØ¹Ø¯ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØª</p>
                            <p class="font-bold text-gray-800 mt-1" id="sessionDateTime"> 
                                <%= displayDateTime %>
                            </p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100">
                            <p class="text-sm font-medium text-gray-500 flex items-center justify-center"><i data-feather="user" class="ml-2 w-4 h-4"></i> Ø§Ù„Ù…Ø¹Ù„Ù…</p>
                            <p class="font-bold text-gray-800 mt-1" id="sessionTutor"><%= sessionDetails.tutorName || 'Ø§Ù„Ù…Ø¹Ù„Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯' %></p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        feather.replace();

        <% if (isSessionValid) { %>
            
            // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ù…Ù† EJS Ø§Ù„Ù…ÙØ¹Ø§Ù„ÙØ¬)
            const sessionTargetDate = new Date('<%= finalISODateTime %>').getTime();
            const joinBeforeMinutes = 10; 
            const durationMinutes = <%= sessionDurationMinutes %>; 
            
            const joinButton = document.getElementById('joinSessionButton');
            const timerMessage = document.getElementById('timerMessage');
            const countdownTimer = document.getElementById('countdownTimer');
            const timerHeader = document.getElementById('timerHeader');
            
            // ğŸ’¡ Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª (ØªÙ… Ø¥Ø²Ø§Ù„Ø© const Ù„ØªÙØ§Ø¯ÙŠ Ø®Ø·Ø£ Ø§Ù„Ù†Ø·Ø§Ù‚)
            let countdownInterval; 

            function updateCountdown() {
                const now = new Date().getTime();
                const distanceToStart = sessionTargetDate - now; // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                
                // Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
                const sessionEndTime = sessionTargetDate + (durationMinutes * 60 * 1000);
                const distanceToEnd = sessionEndTime - now; // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙŠ Ù…Ù†Ø·Ù‚ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±)
                const remainingMinutesToStart = distanceToStart / (1000 * 60);

                // ===============================================
                // Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø­ØµØ©
                // ===============================================
                
                if (distanceToEnd < 0) {
                    // âŒ Ø§Ù„Ø­Ø§Ù„Ø© 1: Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø­ØµØ©
                    clearInterval(countdownInterval);
                    countdownTimer.innerHTML = '<span class="text-2xl font-extrabold text-red-600">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø­ØµØ©!</span>';
                    timerHeader.innerHTML = '<i data-feather="x-circle" class="ml-2 w-6 h-6 text-red-600"></i> Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø­ØµØ©';
                    
                    joinButton.textContent = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø­ØµØ©';
                    joinButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'pointer-events-auto', 'animate-pulse');
                    joinButton.classList.add('bg-red-400', 'pointer-events-none');
                    timerMessage.classList.add('hidden');
                    return;
                    
                } else if (distanceToStart < 0) {
                    // ğŸŸ¢ Ø§Ù„Ø­Ø§Ù„Ø© 2: Ø§Ù„Ø­ØµØ© Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†
                    
                    const runningDistance = distanceToEnd;
                    
                    const oneSecond = 1000;
                    const oneMinute = oneSecond * 60;
                    const oneHour = oneMinute * 60;
                    const oneDay = oneHour * 24;

                    const days = Math.floor(runningDistance / oneDay);
                    const hours = Math.floor((runningDistance % oneDay) / oneHour);
                    const minutes = Math.floor((runningDistance % oneHour) / oneMinute);
                    const seconds = Math.floor((runningDistance % oneMinute) / oneSecond);

                    const formatNumber = (num) => String(num).padStart(2, '0');

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                    if (document.getElementById('days')) {
                        document.getElementById('days').textContent = formatNumber(days);
                        document.getElementById('hours').textContent = formatNumber(hours);
                        document.getElementById('minutes').textContent = formatNumber(minutes);
                        document.getElementById('seconds').textContent = formatNumber(seconds);
                    }
                    
                    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¬Ø§Ø±ÙŠØ©
                    timerHeader.innerHTML = '<i data-feather="activity" class="ml-2 w-6 h-6 text-green-600"></i> Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­ØµØ©:';
                    feather.replace(); 

                    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ ÙˆØªØºÙŠÙŠØ± Ù„ÙˆÙ†Ù‡
                    joinButton.textContent = 'Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¢Ù† (Ø¬Ø§Ø±ÙŠØ©)';
                    joinButton.classList.remove('bg-gray-400', 'hover:bg-gray-500', 'pointer-events-none');
                    joinButton.classList.add('bg-green-600', 'hover:bg-green-700', 'pointer-events-auto', 'animate-pulse');
                    timerMessage.classList.add('hidden');
                    
                    return; // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø£Ù†Ù†Ø§ ÙÙŠ Ø­Ø§Ù„Ø© Ø¬Ø§Ø±ÙŠØ©
                }

                // ğŸŸ¡ Ø§Ù„Ø­Ø§Ù„Ø© 3: Ø§Ù„Ø­ØµØ© Ù‚Ø§Ø¯Ù…Ø© (Ø§Ù„ÙˆÙ‚Øª Ù„Ø§ ÙŠØ²Ø§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
                
                const distance = distanceToStart; // Ù†Ø¹ÙˆØ¯ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

                const oneSecond = 1000;
                const oneMinute = oneSecond * 60;
                const oneHour = oneMinute * 60;
                const oneDay = oneHour * 24;
                
                const days = Math.floor(distance / oneDay);
                const hours = Math.floor((distance % oneDay) / oneHour);
                const minutes = Math.floor((distance % oneHour) / oneMinute);
                const seconds = Math.floor((distance % oneMinute) / oneSecond);
                
                const formatNumber = (num) => String(num).padStart(2, '0');

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù„Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
                if (document.getElementById('days')) {
                    document.getElementById('days').textContent = formatNumber(days);
                    document.getElementById('hours').textContent = formatNumber(hours);
                    document.getElementById('minutes').textContent = formatNumber(minutes);
                    document.getElementById('seconds').textContent = formatNumber(seconds);
                }
                
                // Ù…Ù†Ø·Ù‚ ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                if (remainingMinutesToStart <= joinBeforeMinutes) {
                    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± (10 Ø¯Ù‚Ø§Ø¦Ù‚ Ø£Ùˆ Ø£Ù‚Ù„ Ù…ØªØ¨Ù‚ÙŠØ©)
                    joinButton.classList.remove('bg-gray-400', 'hover:bg-gray-500', 'pointer-events-none');
                    joinButton.classList.add('bg-green-600', 'hover:bg-green-700', 'pointer-events-auto');
                    joinButton.textContent = 'Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¢Ù†';
                    timerMessage.classList.add('hidden');
                    
                    if (remainingMinutesToStart <= 5) {
                         joinButton.classList.add('animate-pulse');
                    } else {
                         joinButton.classList.remove('animate-pulse');
                    }
                    
                } else {
                    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± (Ø§Ù„ÙˆÙ‚Øª Ù„Ø§ ÙŠØ²Ø§Ù„ Ø¨Ø¹ÙŠØ¯Ø§Ù‹)
                    joinButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'pointer-events-auto', 'animate-pulse');
                    joinButton.classList.add('bg-gray-400', 'hover:bg-gray-500', 'pointer-events-none');
                    joinButton.textContent = 'Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¢Ù† (ØºÙŠØ± Ù…ØªØ§Ø­)';
                    timerMessage.classList.remove('hidden');
                }
            }

            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆØªØ­Ø¯ÙŠØ«Ù‡ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
            countdownInterval = setInterval(updateCountdown, 1000);
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
            updateCountdown();

        <% } else { %>
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ØµØ©
             const countdownTimer = document.getElementById('countdownTimer');
             if(countdownTimer) {
                 countdownTimer.innerHTML = '<span class="text-xl text-gray-500 font-medium">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ØµØ©.</span>';
             }
        <% } %>
    </script>
</body>
</html>