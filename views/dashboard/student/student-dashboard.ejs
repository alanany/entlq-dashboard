<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุชุญูู ุงูุทุงูุจ - ุงูุฑุฆูุณูุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .sidebar-link { transition: all 0.2s; }
        .sidebar-link.active { background-color: #eef2ff; color: #4f46e5; font-weight: 700; border-right: 4px solid #4f46e5; }
        .sidebar-link:not(.active):hover { background-color: #f3f4f6; color: #4f46e5; }
        
        /* ุชุญุณููุงุช ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ููููุจุงูู */
        @media (max-width: 1024px) {
            .sidebar-closed { transform: translateX(100%); }
            .sidebar-open { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        
        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>

        <aside id="sidebar" class="fixed inset-y-0 right-0 z-50 w-64 bg-white border-l border-gray-200 flex flex-col transition-transform duration-300 sidebar-closed lg:translate-x-0 lg:static lg:inset-0">
            <div class="h-16 flex items-center justify-between px-6 border-b border-gray-200">
                <span class="text-xl font-extrabold text-indigo-700">๐ ููุตุฉ ุงูุทูู</span>
                <button onclick="toggleSidebar()" class="lg:hidden text-gray-500">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <a href="/student/dashboard" class="sidebar-link active flex items-center px-4 py-3 rounded-lg text-gray-700">
                    <i data-feather="home" class="ml-3 w-5 h-5"></i>
                    ุงูุฑุฆูุณูุฉ
                </a>
                
                <a href="/student/my-sessions" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-700">
                    <i data-feather="calendar" class="ml-3 w-5 h-5"></i>
                    ุฌุฏูู ุงูุญุตุต
                </a>

                <a href="/student/courses_list" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-700">
                    <i data-feather="book-open" class="ml-3 w-5 h-5"></i>
                    ุงุณุชุนุฑุงุถ ุงูููุฑุณุงุช
                </a>

                <a href="/student/enrolled_subscription" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-700">
                    <i data-feather="file-text" class="ml-3 w-5 h-5"></i> 
                    ุทูุจุงุช ุงูุงูุถูุงู
                </a>
                
                <a href="/student/billing" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-700">
                    <i data-feather="dollar-sign" class="ml-3 w-5 h-5"></i>
                    ุงูุฑุตูุฏ ูุงูุฏูุน
                </a>

                <div class="pt-4 border-t border-gray-200 mt-4 space-y-1">
                    <a href="/student/settings" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-700">
                        <i data-feather="settings" class="ml-3 w-5 h-5"></i>
                        ุงูุฅุนุฏุงุฏุงุช
                    </a>
                    <a href="#" onclick="openLogoutModal(event)" class="flex items-center justify-center p-2 mt-4 text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors font-medium">
                        <i data-feather="log-out" class="ml-2 w-5 h-5"></i>
                        ุชุณุฌูู ุงูุฎุฑูุฌ
                    </a>
                </div>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 lg:px-8 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden text-gray-600 p-2 hover:bg-gray-100 rounded-md">
                        <i data-feather="menu"></i>
                    </button>
                    <h2 class="text-lg lg:text-xl font-semibold text-gray-800 truncate">ุฃููุงูุ <%= user.name %>!</h2>
                </div>
                
                <div class="flex items-center space-x-3 space-x-reverse">
                    <div class="hidden md:flex items-center gap-2 border-l pl-4 ml-4">
                        <span class="text-sm font-medium text-gray-600">ุงูุฑุตูุฏ: 4 ุญุตุต</span>
                    </div>
                    <button class="text-gray-500 hover:text-indigo-600 p-1">
                        <i data-feather="bell" class="w-6 h-6"></i>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-4 lg:p-8">
                <div class="max-w-7xl mx-auto space-y-8">

                    <% 
                    // [EJS Logic] ูุนุงูุฌุฉ ุจูุงูุงุช ุงูุญุตุฉ
                    let fullDateTime = 'ุฌุงุฑู ุงูุชุญููู...';
                    let sessionState = 'none'; 
                    let countdownMs = 0;
                    let joinUrl = '#';

                    if (nearestSession && nearestSession.sessionDetails && nearestSession.sessionDetails.date) {
                        const sd = nearestSession.sessionDetails;
                        const dateObj = new Date(sd.date);
                        const finalISODateTime = `${dateObj.toISOString().split('T')[0]}T${sd.time}:00`;
                        const displayDateObj = new Date(finalISODateTime);

                        fullDateTime = displayDateObj.toLocaleString('ar-SA', { 
                            weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' 
                        });
                        
                        joinUrl = `/student/session-details/${nearestSession.bookingId}/${sd._id}`;
                        const now = new Date();
                        const sessionStart = displayDateObj;
                        const sessionEnd = new Date(sessionStart.getTime() + 60*60*1000);

                        if(now >= sessionStart && now <= sessionEnd){
                            sessionState = 'ongoing';
                            countdownMs = sessionEnd.getTime() - now.getTime();
                        } else if(now < sessionStart) {
                            sessionState = 'upcoming';
                        }
                    }
                    %>

                    <% if(sessionState === 'upcoming'){ %>
                        <div class="bg-gradient-to-l from-indigo-700 to-indigo-600 text-white p-6 rounded-2xl shadow-lg border-r-8 border-indigo-400">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                                <div class="flex items-start gap-4">
                                    <div class="p-3 bg-indigo-500/30 rounded-xl">
                                        <i data-feather="monitor" class="w-8 h-8"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl lg:text-2xl font-bold">ูุฏูู ุญุตุฉ ูุงุฏูุฉ ุงูููู</h3>
                                        <p class="text-indigo-100 mt-1 font-medium"><%= nearestSession.courseTitle %></p>
                                        <p class="text-sm text-indigo-200 mt-1 italic"><%= fullDateTime %></p>
                                    </div>
                                </div>
                                <a href="<%= joinUrl %>" class="w-full md:w-auto text-center px-8 py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold transition shadow-md">
                                    ุฏุฎูู ุบุฑูุฉ ุงูุงูุชุธุงุฑ
                                </a>
                            </div>
                        </div>

                    <% } else if(sessionState === 'ongoing'){ %>
                        <div class="bg-gradient-to-r from-red-600 to-orange-500 text-white p-6 rounded-2xl shadow-2xl border-2 border-yellow-400 animate-pulse">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-6 text-center md:text-right">
                                <div class="space-y-2">
                                    <h2 class="text-2xl lg:text-3xl font-black tracking-tight">๐ฅ ุงูุญุตุฉ ุฌุงุฑูุฉ ุงูุขู!</h2>
                                    <p class="text-lg opacity-90"><%= nearestSession.courseTitle %></p>
                                    <p class="font-bold text-xl">ุงูููุช ุงููุชุจูู: <span id="countdown" class="bg-white text-red-600 px-3 py-1 rounded-lg font-mono">--:--</span></p>
                                </div>
                                <a href="<%= joinUrl %>" class="w-full md:w-auto px-10 py-4 bg-yellow-400 text-red-700 font-extrabold text-xl rounded-2xl hover:scale-105 transition-transform shadow-xl">
                                    ุงูุถู ุงูุขู
                                </a>
                            </div>
                        </div>
                        <script>
                            let countdownMs = <%= countdownMs %>;
                            function updateCountdown() {
                                const el = document.getElementById('countdown');
                                if(countdownMs <= 0) { el.innerText = "00:00"; return; }
                                const mins = Math.floor(countdownMs / 60000);
                                const secs = Math.floor((countdownMs % 60000) / 1000);
                                el.innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
                                countdownMs -= 1000;
                            }
                            setInterval(updateCountdown, 1000); updateCountdown();
                        </script>

                    <% } else { %>
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center flex flex-col items-center">
                            <div class="w-20 h-20 bg-gray-50 text-gray-400 rounded-full flex items-center justify-center mb-4">
                                <i data-feather="calendar" class="w-10 h-10"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">ูุง ุชูุฌุฏ ุญุตุต ูุฌุฏููุฉ ุงูููู</h3>
                            <p class="text-gray-500 mt-2 max-w-sm">ููููู ูุฑุงุฌุนุฉ ุฏุฑูุณู ุงูุณุงุจูุฉ ุฃู ุชุตูุญ ุงูุฌุฏูู ุงูุฒููู ููุญุตุต ุงููุงุฏูุฉ.</p>
                            <a href="/student/my-sessions" class="mt-6 inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">
                                <i data-feather="list" class="ml-2 w-5 h-5"></i> ุนุฑุถ ุงูุฌุฏูู
                            </a>
                        </div>
                    <% } %>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
                        <div class="bg-white p-5 rounded-xl border border-gray-100 flex items-center gap-4 shadow-sm">
                            <div class="p-3 bg-green-100 rounded-full text-green-600"><i data-feather="check-square"></i></div>
                            <div>
                                <p class="text-xs font-medium text-gray-500">ุญุตุต ููุชููุฉ</p>
                                <p class="text-2xl font-bold text-gray-900">12</p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-gray-100 flex items-center gap-4 shadow-sm">
                            <div class="p-3 bg-yellow-100 rounded-full text-yellow-600"><i data-feather="star"></i></div>
                            <div>
                                <p class="text-xs font-medium text-gray-500">ุชููููู</p>
                                <p class="text-2xl font-bold text-gray-900">4.8</p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-gray-100 flex items-center gap-4 shadow-sm">
                            <div class="p-3 bg-red-100 rounded-full text-red-600"><i data-feather="zap"></i></div>
                            <div>
                                <p class="text-xs font-medium text-gray-500">ุฏูุงุฆู ุงูุชุนูู</p>
                                <p class="text-2xl font-bold text-gray-900">720</p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-gray-100 flex items-center gap-4 shadow-sm overflow-hidden">
                            <div class="p-3 bg-indigo-100 rounded-full text-indigo-600 flex-shrink-0"><i data-feather="package"></i></div>
                            <div class="truncate">
                                <p class="text-xs font-medium text-gray-500">ุงูุฎุทุฉ</p>
                                <p class="text-lg font-bold text-gray-900 truncate">ุงูุฑูุงุถูุงุช (8 ุญุตุต)</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                                <i data-feather="activity" class="ml-2 w-5 h-5 text-indigo-600"></i> ุฃุญุฏุซ ุงูุฃูุดุทุฉ
                            </h3>
                            <div class="space-y-6">
                                <div class="flex gap-4 items-start">
                                    <div class="w-2 h-2 mt-2 bg-indigo-500 rounded-full flex-shrink-0"></div>
                                    <div class="flex-1 border-b border-gray-50 pb-4">
                                        <p class="font-bold text-gray-900 text-sm">ุชู ุชูููู ุญุตุฉ "ููุฏูุฉ ูู ุงูุจุฑูุฌุฉ"</p>
                                        <p class="text-xs text-gray-600 mt-1 leading-relaxed">ููุช ุจุชูููู ุงููุนูู ุฎุงูุฏ ุนูู ุจู 5 ูุฌูู ููุญุตุฉ ุงูููุชููุฉ.</p>
                                        <span class="text-[10px] text-gray-400 mt-2 block">ููุฐ ููููู</span>
                                    </div>
                                </div>
                                <div class="flex gap-4 items-start">
                                    <div class="w-2 h-2 mt-2 bg-green-500 rounded-full flex-shrink-0"></div>
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-900 text-sm">ุชู ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู</p>
                                        <p class="text-xs text-gray-600 mt-1 leading-relaxed">ูุฌุญุช ุนูููุฉ ุฏูุน ุจุงูุฉ ุงูุฑูุงุถูุงุช ุงููุชูุฏูุฉ.</p>
                                        <span class="text-[10px] text-gray-400 mt-2 block">ููุฐ ุฃุณุจูุน</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                             <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                                 <i data-feather="message-square" class="ml-2 w-5 h-5 text-indigo-600"></i> ููุงุญุธุฉ ุงููุนูู
                             </h3>
                            <div class="bg-indigo-50/50 p-5 rounded-2xl border border-indigo-100 relative">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center text-indigo-700 font-bold">ู</div>
                                    <div>
                                        <p class="text-sm font-bold text-gray-800 leading-none">ููุฑุฉ ููุฏ</p>
                                        <p class="text-[10px] text-gray-500 mt-1 italic">ุงูุฅูุฌููุฒูุฉ</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-700 italic leading-relaxed pr-2 border-r-2 border-indigo-400">
                                    "ูุฌุจ ุงูุชุฑููุฒ ุฃูุซุฑ ุนูู ุงูุฃุฒููุฉ ุงููุชูุฏูุฉ. ุชู ุฅุฑุณุงู ูุงุฌุจ ุฅุถุงูู ูุชูููุฉ ููุงุฑุฉ ุงูุชุญุฏุซ."
                                </p>
                            </div>
                            <a href="#" class="mt-6 block text-center text-sm font-bold text-indigo-600 hover:text-indigo-800 transition">
                                ุนุฑุถ ูุงูุฉ ุงูููุงุญุธุงุช
                            </a>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="logoutModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative z-10 overflow-hidden transform transition-all scale-95">
            <div class="p-8 text-center">
                <div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-feather="log-out" class="w-10 h-10"></i>
                </div>
                <h3 class="text-xl font-extrabold text-gray-900">ุชุฃููุฏ ุงูุฎุฑูุฌ</h3>
                <p class="text-gray-500 mt-3 text-sm leading-relaxed">ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุญุณุงุจู ุงูุขูุ</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex flex-col sm:flex-row-reverse gap-3">
                <a href="/student/logout" class="w-full sm:flex-1 py-3 bg-red-600 text-white rounded-xl font-bold text-sm text-center hover:bg-red-700 shadow-lg shadow-red-200">ูุนูุ ุงุฎุฑุฌ</a>
                <button onclick="closeLogoutModal()" class="w-full sm:flex-1 py-3 bg-white border border-gray-200 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-100">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        // ุงูุชุญูู ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (Sidebar Toggle)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('sidebar-closed');
            sidebar.classList.toggle('sidebar-open');
            overlay.classList.toggle('hidden');
        }

        // ุชุญูู ูุงูุฐุฉ ุชุณุฌูู ุงูุฎุฑูุฌ
        const modal = document.getElementById('logoutModal');
        function openLogoutModal(e) {
            e.preventDefault();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => modal.firstElementChild.nextElementSibling.classList.remove('scale-95'), 10);
        }
        function closeLogoutModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    </script>
</body>
</html>