<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المدربين | أكاديمية انطلق</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .status-pill { transition: all 0.3s ease; }
        .status-active { background-color: #dcfce7; color: #15803d; }
        .status-blocked { background-color: #fee2e2; color: #b91c1c; }
        
        /* انيميشن النوافذ */
        .modal-scale { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .overlay-blur { backdrop-filter: blur(4px); transition: all 0.3s ease; }
    </style>
</head>
<body class="flex h-screen">

            <%- include('./_admin_sidebar.ejs', { currentPage: 'teachers', user: user }) %>

    <main class="flex-1 flex flex-col min-w-0">
        <header class="h-24 bg-white/80 backdrop-blur-md border-b border-slate-100 flex items-center justify-between px-10 sticky top-0 z-10">
            <div>
                <h2 class="text-xl font-black text-slate-800">المعلمون</h2>
            </div>
            <button onclick="showInstructorModal('add')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-[1.5rem] font-black text-sm transition-all shadow-xl shadow-indigo-100 flex items-center gap-2 active:scale-95">
                <i data-feather="user-plus" class="w-4 h-4"></i>
                إضافة معلم جديد
            </button>
        </header>

        <div class="flex-1 overflow-y-auto p-10 no-scrollbar">
            <div class="bg-white rounded-[3rem] shadow-[0_8px_30px_rgb(0,0,0,0.02)] border border-slate-50 overflow-hidden">
                <table class="w-full text-right">
                    <thead class="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-widest border-b border-slate-50">
                        <tr>
                            <th class="px-8 py-6">المدرب</th>
                            <th class="px-8 py-6">التواصل & الكود</th>
                            <th class="px-8 py-6">  سعر الساعة</th>
                            <th class="px-8 py-6 text-center">رابط زووم</th>
                            <th class="px-8 py-6 text-center">الحالة</th>
                            <th class="px-8 py-6 text-left">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                            <% teachers.forEach((teacher, index) => { %>
                        <tr id="row-1" class="hover:bg-slate-50/50 transition-all group">

                            <td class="px-8 py-6">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 font-black text-lg">أ</div>
                                    <div>
                                        <p class="font-black text-slate-800 text-sm"><%= teacher.name %></p>
                                        <p class="text-[10px] font-bold text-slate-400"><%= teacher.email %></p>
                                        <p class="text-[10px] font-bold text-slate-400">default pass:
                                            password123</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-8 py-6 italic text-sm text-slate-500">
                                <span dir="ltr" class="font-bold"><%= teacher.phone_number %></span> <br>
                            </td>
                             <td class="px-8 py-6">
                                <div class="flex items-center gap-4">
                                     <div>
                                        <p class="font-black text-slate-800 text-sm"><%= teacher.hour_rate %></p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-8 py-6 text-center">
                                <a href="#" target="_blank" class="w-10 h-10 bg-indigo-50 text-indigo-500 rounded-xl inline-flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all">
                                    <i data-feather="video" class="w-4 h-4"></i>
                                </a>
                            </td>
                            <td class="px-8 py-6 text-center">
                                <span id="status-1" class="status-pill px-4 py-2 rounded-xl text-[10px] font-black status-active uppercase"><%= teacher.status %></span>
                            </td>
                           
                            <td class="px-8 py-6">
                                <div class="flex items-center justify-end gap-2">
                                    <button onclick="showInstructorModal('edit', <%= JSON.stringify(teacher) %>)" class="p-3 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-xl transition-all"><i data-feather="edit-3" class="w-4 h-4"></i></button>
                                    <button id="block-btn-1" onclick="openConfirm('block', <%= JSON.stringify(teacher) %>)" class="p-3 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-xl transition-all"><i data-feather="slash" class="w-4 h-4"></i></button>
                                    <button onclick="openConfirm('delete', <%= JSON.stringify(teacher) %>)" class="p-3 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </td>
                        </tr>
                         <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="instructorModal" class="fixed inset-0 bg-slate-900/40 z-[100] hidden items-center justify-center p-4 overlay-blur">
        <div id="modalContent" class="bg-white rounded-[3rem] w-full max-w-lg shadow-2xl overflow-hidden transform modal-scale opacity-0 scale-95">
            <div class="bg-indigo-600 p-8 text-white flex justify-between items-center relative overflow-hidden">
                <div class="relative z-10">
                    <h3 id="modalTitle" class="text-xl font-black leading-none">إضافة مدرب</h3>
                    <p class="text-indigo-200 text-[10px] font-bold uppercase tracking-widest mt-2">بيانات الحساب والاتصال</p>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 bg-black/10 hover:bg-black/20 rounded-full flex items-center justify-center relative z-10 transition-all"><i data-feather="x" class="w-5 h-5"></i></button>
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl text-white"></div>
            </div>
            <form id="instructorForm" class="p-8 space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 mr-2 uppercase">الاسم الكامل</label>
                        <input type="text" id="name" required class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-indigo-500/20 transition-all outline-none" placeholder="الاسم الثلاثي">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 mr-2 uppercase">رقم الجوال</label>
                        <input type="tel" id="phone" required dir="ltr" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-indigo-500/20 transition-all outline-none text-right" placeholder="05XXXXXXXX">
                    </div>
                    
                </div>
                <%  const randomId = Math.floor(1000 + Math.random() * 9000);
        const defaultEmail = `teacher_${randomId}@entlq.com`; %>
                   <div class="space-y-1">
                    <label class="text-[10px] font-black text-indigo-500 mr-2 uppercase">  الايميل</label>
                    <input  value=  <%= defaultEmail %> type="email" id="email" dir="ltr" class="w-full bg-indigo-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-indigo-500/20 transition-all outline-none text-left" placeholder="test@gmail.com">
                </div>
                
                  <div class="space-y-1">
                    <label class="text-[10px] font-black text-indigo-500 mr-2 uppercase"> سعر الساعة</label>
                    <input type="number" id="hourlyRate" dir="ltr" class="w-full bg-indigo-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-indigo-500/20 transition-all outline-none text-left" placeholder="00.00">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-indigo-500 mr-2 uppercase">رابط زووم الثابت</label>
                    <input type="url" id="zoom" dir="ltr" class="w-full bg-indigo-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-indigo-500/20 transition-all outline-none text-left" placeholder="https://zoom.us/j/...">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 mr-2 uppercase">ملاحظات إضافية</label>
                    <textarea id="notes" rows="3" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-indigo-500/20 transition-all outline-none resize-none" placeholder="نبذة مختصرة..."></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 py-4 text-slate-400 font-black text-sm hover:bg-slate-50 rounded-2xl transition-all">إلغاء</button>
                    <button type="submit" class="flex-[2] bg-indigo-600 text-white py-4 rounded-2xl font-black text-sm shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all">حفظ البيانات</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDialog" class="fixed inset-0 bg-slate-900/60 z-[110] hidden items-center justify-center p-4 overlay-blur">
        <div id="confirmContent" class="bg-white rounded-[3rem] w-full max-w-sm shadow-2xl overflow-hidden transform modal-scale opacity-0 scale-95">
            <div class="p-10 text-center">
                <div id="confirmIconBg" class="w-24 h-24 mx-auto rounded-[2.5rem] flex items-center justify-center mb-6">
                    <i id="confirmIcon" class="w-10 h-10"></i>
                </div>
                <h3 id="confirmTitle" class="text-2xl font-black text-slate-800 mb-2 tracking-tight">هل أنت متأكد؟</h3>
                <p id="confirmMessage" class="text-xs text-slate-400 font-bold leading-relaxed px-2">سيتم تنفيذ الإجراء فوراً وتحديث بيانات الأكاديمية.</p>
            </div>
            <div class="flex p-6 gap-3 bg-slate-50/50">
                <button onclick="closeConfirm()" class="flex-1 py-4 text-slate-400 font-black text-xs hover:bg-white rounded-2xl transition-all uppercase">تراجع</button>
                <button id="confirmSubmitBtn" class="flex-1 py-4 text-white font-black text-xs rounded-2xl shadow-lg transition-all uppercase active:scale-95">تأكيد الإجراء</button>
            </div>
        </div>
    </div>

   <script>
    feather.replace();

    let currentTeacherId = null; // تخزين معرف المعلم الحالي
    let currentAction = null;    // تخزين الإجراء الحالي (delete, block, activate)

    // --- إدارة المودال (إضافة / تعديل) ---
    function showInstructorModal(type, teacher) {
        const modal = document.getElementById('instructorModal');
        const content = document.getElementById('modalContent');
        modal.classList.replace('hidden', 'flex');
        
        setTimeout(() => { 
            content.classList.remove('opacity-0', 'scale-95'); 
            content.classList.add('opacity-100', 'scale-100'); 
        }, 10);
        
        if(type === 'edit' && teacher) {
            currentTeacherId = teacher._id;
            document.getElementById('modalTitle').innerText = "تعديل المدرب";
            document.getElementById('name').value = teacher.name;
                        document.getElementById('email').value = teacher.email;

            document.getElementById('zoom').value = teacher.zoom_link || '';
            document.getElementById('phone').value = teacher.phone_number || '';
            document.getElementById('notes').value = teacher.notes || '';
            document.getElementById('hourlyRate').value = teacher.hour_rate || '';
        } else {
            currentTeacherId = null;
            document.getElementById('modalTitle').innerText = "إضافة مدرب جديد";
            document.getElementById('instructorForm').reset();
        }
    }

    function closeModal() {
        const content = document.getElementById('modalContent');
        content.classList.replace('opacity-100', 'opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => { document.getElementById('instructorModal').classList.replace('flex', 'hidden'); }, 300);
    }

    // --- إرسال بيانات الفورم (Add/Update) ---
    document.getElementById('instructorForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = {
            name: document.getElementById('name').value,
            zoom_link: document.getElementById('zoom').value,
            phone_number: document.getElementById('phone').value,
            notes: document.getElementById('notes').value,
            hour_rate: document.getElementById('hourlyRate').value,
            email: document.getElementById('email').value
        };

        const url = currentTeacherId ? `/admin/teachers/update/${currentTeacherId}` :
         `/admin/teachers/add`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('خطأ: ' + result.message);
            }
        } catch (err) {
            alert('فشل الاتصال بالسيرفر');
        }
    };

    // --- إدارة حوارات التأكيد (حذف / حظر) ---
    function openConfirm(action, teacher) {
        currentAction = action;
        currentTeacherId = teacher._id; // نأخذ الـ ID من كائن المعلم المرسل
        
        const dialog = document.getElementById('confirmDialog');
        const content = document.getElementById('confirmContent');
        const icon = document.getElementById('confirmIcon');
        const iconBg = document.getElementById('confirmIconBg');
        const title = document.getElementById('confirmTitle');
        const btn = document.getElementById('confirmSubmitBtn');

        // تخصيص شكل النافذة بناءً على الإجراء
        if (action === 'delete') {
            icon.innerHTML = feather.icons['trash-2'].toSvg();
            iconBg.className = "w-24 h-24 mx-auto rounded-[2.5rem] flex items-center justify-center mb-6 bg-red-50 text-red-500 shadow-xl shadow-red-50";
            title.innerText = "حذف المدرب؟";
            btn.className = "flex-1 py-4 bg-red-500 text-white font-black text-xs rounded-2xl shadow-xl shadow-red-100 uppercase";
        } else {
            const isBlock = action === 'block';
            icon.innerHTML = feather.icons[isBlock ? 'slash' : 'user-check'].toSvg();
            iconBg.className = `w-24 h-24 mx-auto rounded-[2.5rem] flex items-center justify-center mb-6 ${isBlock ? 'bg-orange-50 text-orange-500' : 'bg-green-50 text-green-500'}`;
            title.innerText = isBlock ? "حظر الحساب؟" : "تفعيل الحساب؟";
            btn.className = `flex-1 py-4 ${isBlock ? 'bg-orange-500' : 'bg-green-500'} text-white font-black text-xs rounded-2xl uppercase`;
        }

        dialog.classList.replace('hidden', 'flex');
        setTimeout(() => { content.classList.replace('opacity-0', 'opacity-100'); content.classList.replace('scale-95', 'scale-100'); }, 10);
        
        btn.onclick = () => executeConfirmedAction();
    }

    async function executeConfirmedAction() {
        let url = '';
        if (currentAction === 'delete') url = `/admin/teachers/delete/${currentTeacherId}`;
        else url = `/admin/teachers/toggle-status/${currentTeacherId}`;

        try {
            const response = await fetch(url, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                location.reload();
            }
        } catch (err) {
            alert('حدث خطأ أثناء تنفيذ الطلب');
        }
    }

    function closeConfirm() {
        const content = document.getElementById('confirmContent');
        content.classList.replace('opacity-100', 'opacity-0');
        setTimeout(() => { document.getElementById('confirmDialog').classList.replace('flex', 'hidden'); }, 300);
    }
</script>
</body>
</html>