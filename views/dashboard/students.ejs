<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>body { font-family: 'Tajawal', sans-serif; }</style>
</head>
<body class="bg-gray-50 text-gray-800">
    
    <% 
        // ğŸ’¡ Ø§ÙØªØ±Ø§Ø¶: Ø§Ù„Ù…ØªØ­ÙƒÙ… ÙŠÙ…Ø±Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (students)
        // Ù…Ø«Ø§Ù„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„ØºØ±Ø¶ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    

        // ğŸ’¡ Ø§ÙØªØ±Ø§Ø¶: Ø§Ù„Ù…ØªØ­ÙƒÙ… ÙŠÙ…Ø±Ø± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£/Ø§Ù„Ù†Ø¬Ø§Ø­
        const successMessage = locals.success || null;
        const errorMessage = locals.error || null;
    %>

    <div class="flex h-screen overflow-hidden">
        
    <div class="flex h-screen overflow-hidden">
    
    <%- include('./_admin_sidebar.ejs', { currentPage: 'students', user: user }) %>
    
    <div class="flex-1 flex flex-col overflow-hidden">
        </div>
</div>
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center px-8">
                <h2 class="text-xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-8">
                
                <% if (successMessage) { %>
                    <div class="p-4 mb-4 bg-green-100 rounded-lg text-green-700 font-medium flex items-center">
                        <i data-feather="check-circle" class="w-5 h-5 ml-2"></i> <%= successMessage %>
                    </div>
                <% } %>
                <% if (errorMessage) { %>
                    <div class="p-4 mb-4 bg-red-100 rounded-lg text-red-700 font-medium flex items-center">
                        <i data-feather="alert-triangle" class="w-5 h-5 ml-2"></i> <%= errorMessage %>
                    </div>
                <% } %>


                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center flex-wrap gap-4">
                        
                        <div class="flex items-center gap-4">
                            <form action="/admin/students" method="GET" class="relative">
                                <i data-feather="search" class="absolute top-2.5 right-3 w-4 h-4 text-gray-400"></i>
                                <input type="text" name="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." 
                                       value="<%= locals.searchTerm || '' %>"
                                       class="w-64 pr-10 pl-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                                <button type="submit" hidden></button>
                            </form>
                        </div>

                        <button onclick="showAddStudentModal()" class="flex items-center bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors">
                            <i data-feather="user-plus" class="ml-2 w-5 h-5"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-medium">
                                <tr>
                                    <th class="px-6 py-3">Ø§Ù„Ø§Ø³Ù…</th>
                                    <th class="px-6 py-3">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                    <th class="px-6 py-3">Ø§Ù„Ø­Ø§Ù„Ø©</th> 
                                    <th class="px-6 py-3">Ø§Ù„Ø¯ÙˆØ±Ø§Øª</th>
                                    <th class="px-6 py-3">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 text-sm text-gray-700">
                                
                                <% students.forEach(student => { 
                                    const isActive = student.status === 'active';
                                    const statusText = isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø­Ø¸ÙˆØ±';
                                    const statusClass = isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                                    const banAction = isActive ? 'Ø­Ø¸Ø±' : 'ØªÙØ¹ÙŠÙ„';
                                    const banIcon = isActive ? 'user-x' : 'user-check';
                                    const banColor = isActive ? 'text-orange-600 hover:text-orange-800 hover:bg-orange-100' : 'text-green-600 hover:text-green-800 hover:bg-green-100';
                                %>
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 font-medium"><%= student.name %></td>
                                        <td class="px-6 py-4"><%= student.email %></td>
                                        <td class="px-6 py-4">
                                            <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium <%= statusClass %>">
                                                <%= statusText %>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4"><%= student.coursesCount %></td>
                                        <td class="px-6 py-4 flex gap-2">
                                            
                                            <button onclick="showEditStudentModal('<%= student._id %>', '<%= student.name %>', '<%= student.email %>', '<%= student.phone || '' %>')" 
                                                    class="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100" title="ØªØ¹Ø¯ÙŠÙ„">
                                                <i data-feather="edit" class="w-4 h-4"></i>
                                            </button>
                                            
                                            <button onclick="confirmAction('<%= banAction %>', '<%= student.name %>', '/api/admin/students/<%= student._id %>/status')" 
                                                    class="<%= banColor %> p-1 rounded" title="<%= banAction %>">
                                                <i data-feather="<%= banIcon %>" class="w-4 h-4"></i>
                                            </button>
                                            
                                            <button onclick="confirmAction('Ø­Ø°Ù', '<%= student.name %>', '/api/admin/students/<%= student._id %>/delete')" 
                                                    class="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100" title="Ø­Ø°Ù">
                                                <i data-feather="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>

                                <% if (students.length === 0) { %>
                                    <tr>
                                        <td colspan="5" class="px-6 py-6 text-center text-gray-500">
                                            Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ø¹Ø±Ø¶Ù‡Ù….
                                        </td>
                                    </tr>
                                <% } %>
                                
                            </tbody>
                        </table>
                    </div>
                </div>
                
                </main>
        </div>
    </div>

    <div id="addStudentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
            
            <div class="flex justify-between items-center border-b border-gray-100 pb-3 mb-4">
                <h3 class="text-xl font-bold text-indigo-600">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
                <button onclick="hideAddStudentModal()" class="text-gray-400 hover:text-red-500">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form action="/api/admin/students/add" method="POST" class="space-y-4">
                <div><label for="studentName" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="studentName" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                <div><label for="studentEmail" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="studentEmail" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                <div><label for="studentPhone" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="tel" id="studentPhone" name="phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                <div><label for="studentPassword" class="block text-sm font-medium text-gray-700">ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</label><input type="password" id="studentPassword" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                <div class="pt-2">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
            
            <div class="flex justify-between items-center border-b border-gray-100 pb-3 mb-4">
                <h3 class="text-xl font-bold text-blue-600">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <button onclick="hideEditStudentModal()" class="text-gray-400 hover:text-red-500">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="editStudentForm" method="POST" class="space-y-4">
                <input type="hidden" id="editStudentId" name="studentId"> 
                
                <div>
                    <label for="editStudentName" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="editStudentName" name="name" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="editStudentEmail" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="editStudentEmail" name="email" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="editStudentPhone" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="editStudentPhone" name="phone" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                
                <div>
                    <label for="editStudentPassword" class="block text-sm font-medium text-gray-700">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ±)</label>
                    <input type="password" id="editStudentPassword" name="password" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        feather.replace();

        // ------------------ ÙˆØ¸Ø§Ø¦Ù Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Modal ------------------
        function showAddStudentModal() {
            document.getElementById('addStudentModal').classList.remove('hidden');
            document.getElementById('addStudentModal').classList.add('flex');
        }

        function hideAddStudentModal() {
            document.getElementById('addStudentModal').classList.add('hidden');
            document.getElementById('addStudentModal').classList.remove('flex');
        }
        
        // ------------------ ÙˆØ¸Ø§Ø¦Ù ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨ ------------------
        function showEditStudentModal(id, name, email, phone) {
            // Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
            document.getElementById('editStudentId').value = id;
            document.getElementById('editStudentName').value = name;
            document.getElementById('editStudentEmail').value = email;
            document.getElementById('editStudentPhone').value = phone;
            document.getElementById('editStudentPassword').value = ''; // Ù…Ø³Ø­ Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±

            // ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Action) ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ID Ø§Ù„Ø·Ø§Ù„Ø¨
            const form = document.getElementById('editStudentForm');
            // ğŸ’¡ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± (PUT/POST)
            form.action = `/api/admin/students/${id}/edit`; 

            document.getElementById('editStudentModal').classList.remove('hidden');
            document.getElementById('editStudentModal').classList.add('flex');
        }

        function hideEditStudentModal() {
            document.getElementById('editStudentModal').classList.add('hidden');
            document.getElementById('editStudentModal').classList.remove('flex');
        }

        // ------------------ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø¸Ø± ÙˆØ§Ù„Ø­Ø°Ù (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…ÙˆØ°Ø¬ Ù…Ø®ÙÙŠ) ------------------
        // Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨Ø§Øª POST/PUT/DELETE Ù…Ù† Ø²Ø± Ø¹Ø§Ø¯ÙŠ (ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬)
        function confirmAction(action, studentName, endpoint) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ${action} Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentName}ØŸ`)) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… POST)
                const form = document.createElement('form');
                form.method = 'POST'; 
                // ğŸ’¡ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… method-overrideØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡Ù†Ø§
                // form.innerHTML = '<input type="hidden" name="_method" value="DELETE">';
                form.action = endpoint; 
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // ------------------ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ Modals Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§ ------------------
        document.getElementById('addStudentModal').addEventListener('click', function(event) {
            if (event.target === this) { hideAddStudentModal(); }
        });
        document.getElementById('editStudentModal').addEventListener('click', function(event) {
            if (event.target === this) { hideEditStudentModal(); }
        });
        // -----------------------------------------------------------------------
    </script>
</body>
</html>